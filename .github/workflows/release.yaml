name: Build and Release to GHCR

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Docker image tag to publish"
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-verifier:
    uses: ./.github/workflows/build-push-image.yaml
    permissions:
      contents: read
      packages: write
    with:
      service: verifier
      registry: ghcr.io
      image_name: ${{ github.repository }}
      tag: ${{ inputs.tag || github.event.release.tag_name }}
      additional_tag: latest
      proposed_yaml: proposed.yaml

  build-worker:
    uses: ./.github/workflows/build-push-image.yaml
    permissions:
      contents: read
      packages: write
    with:
      service: worker
      registry: ghcr.io
      image_name: ${{ github.repository }}
      tag: ${{ inputs.tag || github.event.release.tag_name }}
      additional_tag: latest

  build-tx-indexer:
    uses: ./.github/workflows/build-push-image.yaml
    permissions:
      contents: read
      packages: write
    with:
      service: tx_indexer
      registry: ghcr.io
      image_name: ${{ github.repository }}
      tag: ${{ inputs.tag || github.event.release.tag_name }}
      additional_tag: latest

# NOTE: Package visibility must be set manually via GitHub UI.
# GitHub's REST API does not support changing package visibility.
# Go to: https://github.com/orgs/vultisig/packages → Package Settings → Change visibility to Public
